name: Release

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

jobs:
  lint-all:
    runs-on: ubuntu-latest
    steps:
      {{> setupGit with=(obj ref="${{ inputs.ref }}")}}
      {{> setupNode}}
      {{> setupDeps}}
      - run: npm run lint --if-present --workspaces --include-workspace-root

  test-all:
    strategy:
      fail-fast: false
      matrix:
        node-version:
          {{#each ciVersions}}
          - {{.}}
          {{/each}}
        platform:
          - os: ubuntu-latest
            shell: bash
          - os: macos-latest
            shell: bash
          {{#if windowsCI}}
          - os: windows-latest
            shell: cmd
          {{/if}}
    runs-on: $\{{ matrix.platform.os }}
    defaults:
      run:
        shell: $\{{ matrix.platform.shell }}
    steps:
      {{> setupGit with=(obj ref="${{ inputs.ref }}")}}
      {{> setupNode useMatrix=true}}
      {{> setupDeps}}
      - name: add tap problem matcher
        run: echo "::add-matcher::.github/matchers/tap.json"
      - run: npm run test --if-present --workspaces --include-workspace-root
