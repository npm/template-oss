name: Release

on:
  push:
    branches:
      {{#each branches}}
      - {{ . }}
      {{/each}}
      {{#each releaseBranches }}
      - {{ . }}
      {{/each}}

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    outputs:
      ref: $\{{ steps.outputs.outputs.ref }}
      sha: $\{{ steps.outputs.outputs.sha }}
    {{> job jobName="Release" }}
      - name: Release Please
        id: release
        env:
          GITHUB_TOKEN: $\{{ secrets.GITHUB_TOKEN }}
        run: {{ rootNpxPath }} --offline template-oss-release-please $\{{ github.ref_name }}
      - name: Set Outputs
        id: outputs
        run: |
          echo "::set-output name=ref::$\{{ fromJSON(steps.release.outputs.pr).headBranchName }}"
          echo "::set-output name=sha::$\{{ fromJSON(steps.release.outputs.pr).sha }}"

  pull-request:
    needs: release
    outputs:
      sha: $\{{ steps.commit.outputs.sha }}
    {{> job
      jobName="Pull Request"
      jobIf="needs.release.outputs.ref"
      jobCheck=(obj sha="${{ needs.release.outputs.sha }}")
      jobCheckout=(obj ref="${{ needs.release.outputs.ref }}" fetch-depth=0)
    }}
      - name: Run Post Pull Request Actions
        run: {{ rootNpmPath }} run rp-pull-request --ignore-scripts {{ allFlags }}
      - name: Commit and Push
        id: commit
        env:
          GITHUB_TOKEN: $\{{ secrets.GITHUB_TOKEN }}
        run: |
          git commit -am "chore: post pull request" || true
          echo "::set-output sha=$(git rev-parse HEAD)"
          git push
      {{> stepChecks jobCheck=(obj name="Pull Request") }}

  ci:
    name: CI - Release
    needs: [release, pull-request]
    uses: ./.github/workflows/ci-release.yml
    with:
      ref: $\{{ needs.release.outputs.ref }}
      check_sha: $\{{ needs.pull-request.outputs.sha }}
